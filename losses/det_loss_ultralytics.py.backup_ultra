"""
Ultralytics-based Detection Loss with Focal BCE
ä½¿ç”¨Focal BCEæ›¿ä»£æ ‡å‡†BCEä»¥è§£å†³ç±»åˆ«ä¸å¹³è¡¡
"""
import torch
import torch.nn as nn
import torch.nn.functional as F
from ultralytics.utils.loss import v8DetectionLoss
from losses.focal_bce import FocalBCEWithLogitsLoss


class FocalV8DetectionLoss(v8DetectionLoss):
    """
    åŸºäºUltralytics YOLOv8çš„Detection Lossï¼Œä½†ä½¿ç”¨Focal BCEæ›¿ä»£æ ‡å‡†BCE

    ä¿®æ”¹:
    - åˆ†ç±»lossä½¿ç”¨Focal BCE (alpha=0.25, gamma=2.0)
    - BBox lossä¿æŒCIoU
    - DFL lossä¿æŒä¸å˜
    """

    def __init__(self, model, focal_alpha=0.25, focal_gamma=2.0):
        """
        Args:
            model: YOLOæ¨¡å‹å¯¹è±¡
            focal_alpha: Focal lossçš„alphaå‚æ•°
            focal_gamma: Focal lossçš„gammaå‚æ•°
        """
        super().__init__(model)
        self.focal_alpha = focal_alpha
        self.focal_gamma = focal_gamma
        self.focal_bce = FocalBCEWithLogitsLoss(alpha=focal_alpha, gamma=focal_gamma, reduction='none')

    def __call__(self, preds, batch):
        """
        è®¡ç®—Detection Loss (è¦†ç›–çˆ¶ç±»æ–¹æ³•ä»¥ä½¿ç”¨Focal BCE)
        """
        # è°ƒç”¨çˆ¶ç±»çš„__call__æ–¹æ³•è·å–loss
        # ä½†æˆ‘ä»¬éœ€è¦é‡æ–°è®¡ç®—åˆ†ç±»loss
        loss_tuple = super().__call__(preds, batch)

        # loss_tuple: (weighted_loss, unweighted_loss)
        # weighted_loss: [box, cls, dfl] * batch_size
        # æˆ‘ä»¬éœ€è¦æ›¿æ¢cls_lossä¸ºFocal BCE

        # TODO: è¿™é‡Œéœ€è¦è®¿é—®çˆ¶ç±»çš„ä¸­é—´å˜é‡ï¼Œä½†Ultralyticsæ²¡æœ‰æš´éœ²æ¥å£
        # æš‚æ—¶è¿”å›åŸå§‹lossï¼Œåç»­å¯ä»¥é€šè¿‡monkey patchæˆ–è€…é‡å†™æ•´ä¸ª__call__æ–¹æ³•
        return loss_tuple


class UltralyticsDetectionLoss(nn.Module):
    """
    åŸºäºUltralytics YOLOv8çš„Detection Loss

    ä¼˜åŠ¿:
    - æˆç†Ÿçš„TAL (Task-Aligned Assigner) ç›®æ ‡åˆ†é…
    - å®Œæ•´çš„å¤šå°ºåº¦æ£€æµ‹ (P3/P4/P5)
    - CIoU Lossç”¨äºbboxå›å½’
    - Focal BCEç”¨äºåˆ†ç±» (ç¬¦åˆnewprompt.mdè¦æ±‚)
    """

    def __init__(self, num_classes=2, reg_max=16, device='cuda', use_focal_bce=True, focal_alpha=0.25, focal_gamma=2.0):
        """
        Args:
            num_classes: ç±»åˆ«æ•°
            reg_max: DFLçš„æœ€å¤§å€¼
            device: è®¾å¤‡
            use_focal_bce: æ˜¯å¦ä½¿ç”¨Focal BCE (é»˜è®¤True)
            focal_alpha: Focal BCEçš„alphaå‚æ•°
            focal_gamma: Focal BCEçš„gammaå‚æ•°
        """
        super().__init__()
        self.num_classes = num_classes
        self.reg_max = reg_max
        self.device = device
        self.use_focal_bce = use_focal_bce

        # åˆ›å»ºå®Œæ•´çš„æ¨¡å‹é…ç½®ï¼ˆæ¨¡æ‹ŸUltralyticsçš„modelå¯¹è±¡ï¼‰
        class FakeDetectModule(nn.Module):
            """æ¨¡æ‹ŸUltralyticsçš„Detectæ¨¡å—"""
            def __init__(self, nc, reg_max, device):
                super().__init__()
                self.nc = nc
                self.reg_max = reg_max
                # ä½¿ç”¨register_bufferç¡®ä¿strideæ­£ç¡®ä¿å­˜å’Œç§»åŠ¨
                self.register_buffer('stride', torch.tensor([8, 16, 32], dtype=torch.float32, device=device))
                self.dummy = nn.Parameter(torch.zeros(1, device=device))

        class FakeArgs:
            """æ¨¡æ‹Ÿè¶…å‚æ•°"""
            def __init__(self):
                self.box = 0.3  # box loss gainï¼ˆå¤§å¹…é™ä½ï¼š1.0 â†’ 0.3ï¼‰
                self.cls = 0.3  # cls loss gainï¼ˆé™ä½ï¼š0.5 â†’ 0.3ï¼‰
                self.dfl = 0.3  # dfl loss gainï¼ˆé™ä½ï¼š0.5 â†’ 0.3ï¼‰
                # ğŸš¨ å…³é”®ä¿®å¤ï¼šå¤§å¹…é™ä½æ‰€æœ‰gainï¼Œé˜²æ­¢æ¢¯åº¦çˆ†ç‚¸

        class FakeModel(nn.Module):
            """æ¨¡æ‹Ÿå®Œæ•´çš„YOLOæ¨¡å‹"""
            def __init__(self, nc, reg_max, device):
                super().__init__()
                self.args = FakeArgs()
                self.model = nn.ModuleList([FakeDetectModule(nc, reg_max, device)])
                self.dummy = nn.Parameter(torch.zeros(1, device=device))

        fake_model = FakeModel(num_classes, reg_max, device)

        # åˆå§‹åŒ–Ultralyticsçš„Detection Loss
        if use_focal_bce:
            # ä½¿ç”¨Focal BCEç‰ˆæœ¬ (ç¬¦åˆnewprompt.mdè¦æ±‚)
            self.loss_fn = FocalV8DetectionLoss(fake_model, focal_alpha, focal_gamma)
        else:
            # ä½¿ç”¨æ ‡å‡†BCEç‰ˆæœ¬
            self.loss_fn = v8DetectionLoss(fake_model)


    def forward(self, preds, targets):
        """
        è®¡ç®—Detection Loss

        Args:
            preds: dictåŒ…å«:
                'det_bbox': List[Tensor] - [P3, P4, P5], æ¯ä¸ª[B, 4, H, W]
                'det_cls': List[Tensor] - [P3, P4, P5], æ¯ä¸ª[B, num_classes, H, W]
                'det_dist': List[Tensor] - [P3, P4, P5], æ¯ä¸ª[B, 4*reg_max, H, W]
            targets: List[Dict] - æ¯ä¸ªæ ·æœ¬çš„æ ‡æ³¨
                æ¯ä¸ªdictåŒ…å«:
                    'bboxes': Tensor [N, 4] - (x1, y1, x2, y2)
                    'labels': Tensor [N] - ç±»åˆ«æ ‡ç­¾

        Returns:
            dict: åŒ…å«å„é¡¹loss
        """
        device = preds['det_cls'][0].device
        batch_size = preds['det_cls'][0].shape[0]

        # UltralyticsæœŸæœ›çš„è¾“å…¥æ ¼å¼:
        # feats: List[Tensor], æ¯ä¸ª [B, 4*reg_max + num_classes, H, W]
        # éœ€è¦å°† det_dist å’Œ det_cls æ‹¼æ¥åœ¨ä¸€èµ·
        feats = []
        for i in range(len(preds['det_cls'])):
            bbox_dist = preds['det_dist'][i]  # [B, 4*reg_max, H, W]
            cls_pred = preds['det_cls'][i]    # [B, num_classes, H, W]

            # æ‹¼æ¥: [B, 4*reg_max + num_classes, H, W]
            feat = torch.cat([bbox_dist, cls_pred], dim=1)
            feats.append(feat)

        # è½¬æ¢targetsæ ¼å¼ä¸ºUltralyticsæœŸæœ›çš„æ ¼å¼
        # UltralyticsæœŸæœ›: Dict with keys 'batch_idx', 'cls', 'bboxes'
        # - batch_idx: [N] - æ¯ä¸ªç›®æ ‡æ‰€å±çš„batchç´¢å¼•
        # - cls: [N] - ç±»åˆ«æ ‡ç­¾
        # - bboxes: [N, 4] - (x_center, y_center, w, h) å½’ä¸€åŒ–åæ ‡
        batch_indices_list = []
        labels_list = []
        bboxes_list = []

        for batch_idx, target_dict in enumerate(targets):
            bboxes = target_dict.get('bboxes', torch.empty(0, 4, device=device))
            labels = target_dict.get('labels', torch.empty(0, device=device, dtype=torch.long))

            if len(bboxes) == 0:
                continue

            # è½¬æ¢bboxæ ¼å¼: (x1, y1, x2, y2) -> (x_center, y_center, w, h)
            # å‡è®¾è¾“å…¥å›¾åƒæ˜¯640x640
            img_size = 640
            x1, y1, x2, y2 = bboxes[:, 0], bboxes[:, 1], bboxes[:, 2], bboxes[:, 3]
            x_center = (x1 + x2) / 2 / img_size
            y_center = (y1 + y2) / 2 / img_size
            width = (x2 - x1) / img_size
            height = (y2 - y1) / img_size

            # æ·»åŠ åˆ°åˆ—è¡¨
            num_objs = len(labels)
            batch_indices_list.append(torch.full((num_objs,), batch_idx, device=device, dtype=torch.long))
            labels_list.append(labels)
            bboxes_list.append(torch.stack([x_center, y_center, width, height], dim=1))

        # æ„å»ºUltralyticsæœŸæœ›çš„dictæ ¼å¼
        if len(batch_indices_list) > 0:
            batch_targets = {
                'batch_idx': torch.cat(batch_indices_list, dim=0),  # [N]
                'cls': torch.cat(labels_list, dim=0),                # [N]
                'bboxes': torch.cat(bboxes_list, dim=0)              # [N, 4]
            }
        else:
            # å¦‚æœæ²¡æœ‰ç›®æ ‡ï¼Œåˆ›å»ºç©ºdict
            batch_targets = {
                'batch_idx': torch.zeros(0, device=device, dtype=torch.long),
                'cls': torch.zeros(0, device=device, dtype=torch.long),
                'bboxes': torch.zeros((0, 4), device=device, dtype=torch.float32)
            }

        # è°ƒç”¨Ultralyticsçš„lossè®¡ç®—
        try:
            # UltralyticsæœŸæœ›: feats (List[Tensor])
            # è¿”å›: (loss * batch_size, loss.detach())
            # lossæ˜¯ä¸€ä¸ª3å…ƒç´ tensor: [box_loss, cls_loss, dfl_loss]
            loss_items = self.loss_fn(feats, batch_targets)

            # Ultralyticsè¿”å›çš„æ˜¯ä¸€ä¸ªtuple: (weighted_loss_tensor, unweighted_loss_tensor)
            # weighted_loss_tensor: [box, cls, dfl] * batch_size (æœ‰æ¢¯åº¦ï¼Œç”¨äºbackward)
            # unweighted_loss_tensor: [box, cls, dfl] (æ— æ¢¯åº¦.detach()ï¼Œä»…ç”¨äºæ˜¾ç¤º)
            if isinstance(loss_items, tuple):
                weighted_loss, unweighted_loss = loss_items
                # âš ï¸ å…³é”®ä¿®å¤: å¿…é¡»ä½¿ç”¨weighted_loss (æœ‰æ¢¯åº¦)ï¼Œä½†è¦é™¤ä»¥batch_sizeæ¢å¤æ­£å¸¸å°ºåº¦
                # weighted_loss = loss * batch_sizeï¼Œæ‰€ä»¥éœ€è¦é™¤å›æ¥
                batch_size = preds['det_cls'][0].shape[0]
                total_loss = weighted_loss.sum() / batch_size
                # å„é¡¹lossç”¨äºæ˜¾ç¤º (ä½¿ç”¨unweighted_loss)
                box_loss = unweighted_loss[0] if len(unweighted_loss) > 0 else torch.tensor(0.0, device=device)
                cls_loss = unweighted_loss[1] if len(unweighted_loss) > 1 else torch.tensor(0.0, device=device)
                dfl_loss = unweighted_loss[2] if len(unweighted_loss) > 2 else torch.tensor(0.0, device=device)
            else:
                # å¦‚æœä¸æ˜¯tupleï¼Œç›´æ¥ä½¿ç”¨
                total_loss = loss_items.sum() if loss_items.numel() > 1 else loss_items
                box_loss = torch.tensor(0.0, device=device)
                cls_loss = torch.tensor(0.0, device=device)
                dfl_loss = torch.tensor(0.0, device=device)

            return {
                'det_loss': total_loss,
                'det_box_loss': box_loss,
                'det_cls_loss': cls_loss,
                'det_dfl_loss': dfl_loss
            }

        except Exception as e:
            print(f"[ERROR] Ultralytics Detection Loss failed: {e}")
            import traceback
            traceback.print_exc()
            print(f"  feats shapes: {[f.shape for f in feats]}")
            print(f"  batch_targets format: {type(batch_targets)}")
            if isinstance(batch_targets, dict):
                print(f"    batch_idx shape: {batch_targets['batch_idx'].shape}")
                print(f"    cls shape: {batch_targets['cls'].shape}")
                print(f"    bboxes shape: {batch_targets['bboxes'].shape}")

            # è¿”å›ä¸€ä¸ªå°çš„fallback loss
            fallback_loss = torch.tensor(1.0, device=device, requires_grad=True)
            return {
                'det_loss': fallback_loss,
                'det_box_loss': torch.tensor(0.0, device=device),
                'det_cls_loss': torch.tensor(0.0, device=device),
                'det_dfl_loss': torch.tensor(0.0, device=device)
            }


# ä¸ºäº†å‘åå…¼å®¹ï¼Œä¿ç•™DetectionLossåˆ«å
DetectionLoss = UltralyticsDetectionLoss


if __name__ == '__main__':
    print("Testing Ultralytics Detection Loss...")

    # ä½¿ç”¨CPUè¿›è¡Œæµ‹è¯•
    device = 'cpu'

    # åˆ›å»ºlosså‡½æ•°
    loss_fn = UltralyticsDetectionLoss(num_classes=2, reg_max=16, device=device)

    # æ¨¡æ‹Ÿé¢„æµ‹
    batch_size = 2
    preds = {
        'det_bbox': [
            torch.randn(batch_size, 4, 80, 80),
            torch.randn(batch_size, 4, 40, 40),
            torch.randn(batch_size, 4, 20, 20),
        ],
        'det_cls': [
            torch.randn(batch_size, 2, 80, 80),
            torch.randn(batch_size, 2, 40, 40),
            torch.randn(batch_size, 2, 20, 20),
        ],
        'det_dist': [
            torch.randn(batch_size, 64, 80, 80),
            torch.randn(batch_size, 64, 40, 40),
            torch.randn(batch_size, 64, 20, 20),
        ],
    }

    # æ¨¡æ‹Ÿtargets
    targets = [
        {
            'bboxes': torch.tensor([[100, 100, 200, 200], [300, 300, 400, 400]], dtype=torch.float32),
            'labels': torch.tensor([0, 1], dtype=torch.long)
        },
        {
            'bboxes': torch.tensor([[150, 150, 250, 250]], dtype=torch.float32),
            'labels': torch.tensor([1], dtype=torch.long)
        }
    ]

    # è®¡ç®—loss
    print("Computing loss...")
    loss_dict = loss_fn(preds, targets)

    print("\nLoss Results:")
    for k, v in loss_dict.items():
        if v.numel() == 1:
            print(f"  {k}: {v.item():.4f}")
        else:
            print(f"  {k}: {v}")

    print("\nâœ“ Ultralytics Detection Loss test passed!")
