# Detection-Only Anti-Overfit Configuration
# 专门用于解决过拟合问题的优化配置

# ===== 数据集路径配置 =====
data:
  # COCO Detection (Person & Car)
  coco:
    root: "./coco2017"
    train_img: "train2017"
    val_img: "val2017"
    train_ann: "annotations/instances_train2017.json"
    val_ann: "annotations/instances_val2017.json"
    classes: [1, 3]  # 1: person, 3: car

  # 子集设置
  subset:
    enabled: false
    det_samples: null

# ===== 模型架构配置 =====
model:
  backbone:
    type: "mobilenetv3_large"
    pretrained: true
    out_indices: [6, 12, 16]

  neck:
    type: "PANet"
    out_channels: 256

  heads:
    detection:
      num_classes: 2
      anchors_per_level: 1
      strides: [8, 16, 32]

# ===== 损失函数配置（Anti-Overfit）=====
loss:
  detection:
    bbox_loss: "CIoU"
    obj_loss: "Focal"
    cls_loss: "BCE"

    # Focal Loss参数
    use_focal_obj: true
    focal_alpha: 0.5   # ✅ 中间值，平衡正负样本（正=0.5，负=0.5）
    focal_gamma: 3.0   # ✅ 提高到3.0，更强力抑制易分类负样本

    # Objectness正样本权重
    pos_weight: 40.0   # ✅ 从60降到40（总权重：40×0.5=20 vs 0.5×400=200，比例1:10，合理）

    # ✅ Label Smoothing（防止cls过拟合）
    label_smoothing: 0.1  # 0.1效果最佳

# ===== 训练配置（Anti-Overfit）=====
train:
  # 基础设置
  epochs: 100
  batch_size: 64  # 降低batch_size减少共享内存压力
  num_workers: 4
  pin_memory: true
  prefetch_factor: 2

  # 输入尺寸
  img_size: 640

  # ✅ 增强的数据增强
  augmentation:
    # 基础增强
    horizontal_flip: 0.5

    # ✅ 几何变换（增强）
    shift_scale_rotate:
      enabled: true
      shift_limit: 0.1
      scale_limit: 0.2
      rotate_limit: 10
      prob: 0.5

    # ✅ 颜色增强（增强）
    color_jitter:
      brightness: 0.2  # 从0.1提高到0.2
      contrast: 0.2
      saturation: 0.2
      hue: 0.1
      prob: 0.5  # 从0.3提高到0.5

    random_brightness_contrast:
      enabled: true
      prob: 0.3

    # ✅ Mosaic增强（YOLO标准）
    mosaic:
      enabled: true
      prob: 0.5  # 50%概率使用Mosaic

    # ✅ Mixup增强
    mixup:
      enabled: true
      alpha: 0.2
      prob: 0.3  # 30%概率使用Mixup

  # ✅ 优化器（Anti-Overfit）
  optimizer:
    type: "AdamW"
    lr: 0.005  # ✅ 从0.01降低到0.005
    weight_decay: 0.0005  # ✅ 从0.0001提高到0.0005（5倍）
    betas: [0.9, 0.999]

  # ✅ 学习率调度（Anti-Overfit）
  scheduler:
    type: "CosineAnnealingLR"
    warmup_epochs: 10  # ✅ 从5提高到10
    warmup_lr: 0.0001
    min_lr: 0.00001  # ✅ 从0.00001降低

  # 梯度累积
  accumulate_grad: 1

  # 混合精度训练
  amp: true

  # ✅ EMA（Exponential Moving Average）
  ema:
    enabled: true
    decay: 0.9999

# ===== 验证配置 =====
val:
  interval: 5
  batch_size: 32
  img_size: 640

# ===== 保存与日志 =====
output:
  save_dir: "runs/det_anti_overfit"
  save_interval: 10
  save_best: true
  resume: null

# ===== 早停机制（Anti-Overfit）=====
early_stopping:
  enabled: true
  patience: 10  # ✅ 从15降低到10（更激进）
  min_delta: 0.001
  monitor: "val_det_loss"

logging:
  use_tensorboard: true
  log_dir: "runs/logs"
  print_interval: 50

# ===== 设备配置 =====
device:
  gpu_ids: [0]
  distributed: false
  seed: 42

# ===== 修复说明 =====
# 本配置针对过拟合问题的修复：
# 1. ✅ Label Smoothing (0.1) - 防止cls_loss过拟合
# 2. ✅ 增强数据增强 - Mosaic + Mixup + 更强的几何/颜色变换
# 3. ✅ 提高weight_decay (0.0001 → 0.0005) - 增强正则化
# 4. ✅ 降低学习率 (0.01 → 0.005) - 平滑收敛
# 5. ✅ 增加warmup (5 → 10) - 更稳定的训练开始
# 6. ✅ 更激进早停 (patience: 15 → 10) - 更快停止
#
# 预期效果：
# - 验证Loss改善: 0.8729 → 0.75-0.80
# - cls_loss差距: 8.4x → <2x
# - mAP提升: 0.14 → 0.3-0.5
