# Detection-Only Pre-training Configuration
# 纯检测预训练，为后续多任务学习打基础

# ===== 数据集路径配置 =====
data:
  # COCO Detection (Person & Car)
  coco:
    root: "./coco2017"
    train_img: "train2017"
    val_img: "val2017"
    train_ann: "annotations/instances_train2017.json"
    val_ann: "annotations/instances_val2017.json"
    classes: [1, 3]  # 1: person, 3: car

  # 子集设置（用于快速测试）
  subset:
    enabled: false
    det_samples: null

# ===== 模型架构配置 =====
model:
  backbone:
    type: "mobilenetv3_large"
    pretrained: true
    out_indices: [6, 12, 16]  # C3, C4, C5

  neck:
    type: "PANet"
    out_channels: 256

  heads:
    detection:
      num_classes: 2
      anchors_per_level: 1  # Anchor-free
      strides: [8, 16, 32]

# ===== 损失函数配置 =====
loss:
  detection:
    bbox_loss: "CIoU"
    obj_loss: "Focal"  # 使用Focal Loss处理正负样本不平衡
    cls_loss: "BCE"

    # Focal Loss参数（已优化）
    use_focal_obj: true
    focal_alpha: 0.75
    focal_gamma: 2.0

    # Objectness正样本权重（已优化）
    pos_weight: 4.0  # 不再是640！

# ===== 训练配置 =====
train:
  # 基础设置
  epochs: 100
  batch_size: 64  # 降低到64避免shared memory耗尽（32GB GPU）
  num_workers: 4  # 限制为4避免Bus error
  pin_memory: true
  prefetch_factor: 2  # 降低预取减少内存压力

  # 输入尺寸
  img_size: 640

  # 数据增强（已简化，提升速度）
  augmentation:
    horizontal_flip: 0.5
    color_jitter:
      brightness: 0.1
      contrast: 0.1
      saturation: 0.1
      hue: 0.05
      prob: 0.3

  # 优化器
  optimizer:
    type: "AdamW"
    lr: 0.01
    weight_decay: 0.0001
    betas: [0.9, 0.999]

  # 学习率调度
  scheduler:
    type: "CosineAnnealingLR"
    warmup_epochs: 5
    warmup_lr: 0.0001
    min_lr: 0.00001

  # 梯度累积
  accumulate_grad: 1

  # 混合精度训练（强制启用）
  amp: true

  # EMA
  ema:
    enabled: true
    decay: 0.9999

# ===== 验证配置 =====
val:
  interval: 5
  batch_size: 32
  img_size: 640

# ===== 保存与日志 =====
output:
  save_dir: "runs/det_pretrain"
  save_interval: 10
  save_best: true
  resume: null

# ===== 早停机制 =====
early_stopping:
  enabled: true
  patience: 15
  min_delta: 0.001
  monitor: "val_det_loss"

logging:
  use_tensorboard: true
  log_dir: "runs/logs"
  print_interval: 50

# ===== 设备配置 =====
device:
  gpu_ids: [0]
  distributed: false
  seed: 42

# ===== 性能优化备注 =====
# 本配置已包含以下优化：
# 1. 向量化Loss计算（VectorizedYOLOLoss）
# 2. AMP混合精度训练（FP16）
# 3. 优化的pos_weight=4.0和Focal Loss
# 4. 高效DataLoader配置（workers=8, prefetch=4）
# 5. 简化数据增强pipeline
# 预期训练速度：1-2s/it（vs 优化前10s/it）
